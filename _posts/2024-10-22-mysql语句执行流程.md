---
layout: post
title: "我的八股"
date:   2024-10-22
tags: [八股]
comments: true
author: zy0410
---

Mysql的架构共分为两层：Server层和存储引擎层；Server层负责建立连接、分析和执行SQL；存储引擎层负责数据的存储和提取。

### 第一步：执行器

```sql
mysql -h$ip -u$user -p
```

- 连接过程需要TCP三次握手，若Mysql服务器没启动则报错。若正常运行，则在完成TCP连接够，验证用户名和密码，密码错误则报错：Access denied for user的错误，若正确，获取此用户权限并保存，后续该用户的操作都会基于连接开始时读到的权限进行权限逻辑的判断。
- 中途修改用户权限在重新连接后才开始生效。
- 连接数有限制
- 连接分为长连接和短连接，Mysql用长连接。
- 解决长连接内存占用：定期断开长连接（下次需重连）；客户端主动重置连接（下次不需重连）

### 第二步：查询缓存

- Mysql收到SQL语句后，解析SQL的第一个字段，如果是select语句，就先去查询缓存（key-value,key是SQL查询语句，value为SQL查询的结果）。

- Mysql8.0版本将查询缓存删掉了，从8.0开始不在走到查询缓存这个阶段；之前的版本可用query_cache_type设置成DEMAND关闭缓存。（Server层的查询缓存，而不是Innodb中的Buffer pool）

  

  
  
  

### 第三步：解析SQL

- 第一，词法解析：识别出SQL的关键字，select from insert等等
- 第二：语法分析：根据此法分析的结果，判断SQL是否符合语法。没问题则构建出SQL语法树，方便后面模块获取SQL类型、表名、字段名、where条件等等。



### 第四步：执行SQL

SQL查询语句的流程，每条SELECT都主要分为三个阶段：

1. prepare阶段,预处理器：
   - 检查SQL查询语句中的表或者字段是否存在
   - 将select *中的*符号。扩展为表彰的所有列
2. optimize阶段，优化器：
   - 为查询的SQL制定一个执行计划，基于成本考虑
   - explain命令可以详细看见执行计划
   - 主键索引B+树的成本会比二级索引的B+成本大(当可以直接在二级索引中查出数据，则不用主键索引，**索引覆盖**)
3. execute阶段，执行器：
   - 执行过程中与存储引擎交互，以记录为单位
   - 三种交互方式：
     1. 主键索引查询
     2. 全表扫描
     3. 索引下推



